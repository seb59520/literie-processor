<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Postes Clients - MATELAS Update Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .client-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .client-card:hover {
            transform: translateY(-5px);
        }
        .online-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .online { background-color: #28a745; }
        .offline { background-color: #dc3545; }
        .away { background-color: #ffc107; }
        .os-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .version-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-satellite-dish me-2"></i>
                MATELAS Update Center Pro
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link active" href="/admin/clients">
                    <i class="fas fa-users me-1"></i>Clients
                </a>
                <a class="nav-link" href="/admin/upload">
                    <i class="fas fa-upload me-1"></i>Upload
                </a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="container my-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-users text-primary me-3"></i>
                    Gestion des Postes Clients
                </h2>
            </div>
        </div>

        <!-- Statistiques Rapides -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <i class="fas fa-desktop fa-2x mb-2"></i>
                        <h4>{{ client_stats.total_clients }}</h4>
                        <small>Total Postes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <i class="fas fa-wifi fa-2x mb-2"></i>
                        <h4>{{ client_stats.active_clients }}</h4>
                        <small>Actifs (24h)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <i class="fas fa-windows fa-2x mb-2"></i>
                        <h4>{{ client_stats.os_distribution.get('Windows', 0) }}</h4>
                        <small>Windows</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-secondary text-white">
                    <div class="card-body">
                        <i class="fas fa-linux fa-2x mb-2"></i>
                        <h4>{{ client_stats.os_distribution.get('Linux', 0) + client_stats.os_distribution.get('Darwin', 0) }}</h4>
                        <small>Linux/Mac</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchFilter" placeholder="üîç Rechercher par nom de poste ou utilisateur...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="statusFilter">
                            <option value="">Tous les statuts</option>
                            <option value="online">En ligne (24h)</option>
                            <option value="away">Inactif (1-7 jours)</option>
                            <option value="offline">Hors ligne (>7 jours)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="versionFilter">
                            <option value="">Toutes les versions</option>
                            {% for version, count in client_stats.versions_distribution.items() %}
                            <option value="{{ version }}">{{ version }} ({{ count }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="hideUnknownFilter" 
                                   {% if hide_unknown %}checked{% endif %} 
                                   onchange="toggleUnknownFilter()">
                            <label class="form-check-label" for="hideUnknownFilter">
                                <i class="fas fa-eye-slash me-1"></i>Masquer postes inconnus
                            </label>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()" title="R√©initialiser les filtres">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-warning w-100" onclick="cleanupOldClients()" title="Supprimer les clients inactifs">
                            <i class="fas fa-broom"></i>
                        </button>
                    </div>
                </div>
                {% if hide_unknown %}
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="fas fa-filter me-2"></i>
                            <strong>Filtrage actif:</strong> {{ total_clients - visible_clients }} postes fant√¥mes masqu√©s. 
                            Affichage de {{ visible_clients }} sur {{ total_clients }} postes.
                            <a href="/admin/clients" class="alert-link">Afficher tous</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Liste des Clients -->
        <div class="row" id="clientsList">
            {% if clients %}
                {% for client in clients %}
                <div class="col-md-6 col-lg-4 mb-4 client-item" 
                     data-hostname="{{ client.system_info.hostname }}"
                     data-username="{{ client.system_info.username }}"
                     data-version="{{ client.current_version }}"
                     data-last-seen="{{ client.last_seen }}">
                    <div class="card client-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <!-- Indicateur de statut (simplifi√©) -->
                                <span class="online-indicator online" title="Client enregistr√©"></span>
                                
                                <!-- Ic√¥ne OS -->
                                {% if "Windows" in client.system_info.platform %}
                                    <i class="fab fa-windows os-icon text-primary" title="Windows"></i>
                                {% elif "Darwin" in client.system_info.platform %}
                                    <i class="fab fa-apple os-icon text-secondary" title="macOS"></i>
                                {% elif "Linux" in client.system_info.platform %}
                                    <i class="fab fa-linux os-icon text-warning" title="Linux"></i>
                                {% else %}
                                    <i class="fas fa-desktop os-icon text-muted" title="Inconnu"></i>
                                {% endif %}
                            </div>
                            <small class="text-muted">ID: {{ client.client_id[:8] }}...</small>
                        </div>
                        
                        <div class="card-body">
                            <!-- Nom du poste -->
                            <h6 class="card-title">
                                <i class="fas fa-desktop me-2"></i>
                                {{ client.system_info.hostname or "Poste-Inconnu" }}
                            </h6>
                            
                            <!-- Utilisateur -->
                            <p class="card-text">
                                <i class="fas fa-user me-2 text-muted"></i>
                                <strong>{{ client.system_info.username or "Utilisateur-Inconnu" }}</strong>
                            </p>
                            
                            <!-- Version -->
                            <p class="card-text">
                                <i class="fas fa-tag me-2 text-muted"></i>
                                <span class="badge bg-primary version-badge">
                                    v{{ client.current_version or "Inconnue" }}
                                </span>
                            </p>
                            
                            <!-- Syst√®me -->
                            <p class="card-text">
                                <i class="fas fa-cog me-2 text-muted"></i>
                                {{ client.system_info.platform or "Syst√®me inconnu" }}
                            </p>
                            
                            <!-- Adresse IP -->
                            <p class="card-text">
                                <i class="fas fa-network-wired me-2 text-muted"></i>
                                <small class="text-muted">{{ client.ip_address }}</small>
                            </p>
                        </div>
                        
                        <div class="card-footer text-muted">
                            <div class="d-flex justify-content-between align-items-center">
                                <small>
                                    <i class="fas fa-clock me-1"></i>
                                    Derni√®re connexion
                                </small>
                                <small>
                                    <strong>{{ client.last_seen[:16].replace('T', ' ') }}</strong>
                                </small>
                            </div>
                            
                            <!-- Actions -->
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info me-1" onclick="showClientDetails('{{ client.client_id }}')">
                                    <i class="fas fa-info-circle"></i> D√©tails
                                </button>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="pingClient('{{ client.client_id }}')">
                                    <i class="fas fa-satellite-dish"></i> Ping
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('{{ client.client_id }}', '{{ client.system_info.hostname or "Poste-Inconnu" }}')">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-users fa-5x text-muted mb-3"></i>
                    <h5 class="text-muted">Aucun poste client enregistr√©</h5>
                    <p class="text-muted">Les postes appara√Ætront ici d√®s qu'ils v√©rifieront les mises √† jour</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal D√©tails Client -->
    <div class="modal fade" id="clientDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-desktop me-2"></i>
                        D√©tails du Poste Client
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="clientDetailsBody">
                    <!-- Contenu charg√© dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Filtrage en temps r√©el
        document.getElementById('searchFilter').addEventListener('input', filterClients);
        document.getElementById('statusFilter').addEventListener('change', filterClients);
        document.getElementById('versionFilter').addEventListener('change', filterClients);

        function filterClients() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const versionFilter = document.getElementById('versionFilter').value;
            
            const clients = document.querySelectorAll('.client-item');
            
            clients.forEach(client => {
                const hostname = client.dataset.hostname.toLowerCase();
                const username = client.dataset.username.toLowerCase();
                const version = client.dataset.version;
                const lastSeen = client.dataset.lastSeen;
                
                // Calcul du statut
                const hoursAgo = (new Date() - new Date(lastSeen)) / (1000 * 60 * 60);
                let status = 'offline';
                if (hoursAgo < 24) status = 'online';
                else if (hoursAgo < 168) status = 'away';
                
                // Filtres
                const matchesSearch = hostname.includes(searchTerm) || username.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesVersion = !versionFilter || version === versionFilter;
                
                if (matchesSearch && matchesStatus && matchesVersion) {
                    client.style.display = 'block';
                } else {
                    client.style.display = 'none';
                }
            });
        }

        function resetFilters() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('versionFilter').value = '';
            document.getElementById('hideUnknownFilter').checked = false;
            // Rediriger vers la page sans filtres
            window.location.href = '/admin/clients';
        }

        function toggleUnknownFilter() {
            const hideUnknown = document.getElementById('hideUnknownFilter').checked;
            const currentUrl = new URL(window.location);
            
            if (hideUnknown) {
                currentUrl.searchParams.set('hide_unknown', 'true');
            } else {
                currentUrl.searchParams.delete('hide_unknown');
            }
            
            window.location.href = currentUrl.toString();
        }

        function showClientDetails(clientId) {
            // Charger les d√©tails du client via AJAX
            fetch(`/api/v1/clients/${clientId}/details`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('clientDetailsBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Informations Syst√®me</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Poste:</strong> ${data.hostname || 'Inconnu'}</li>
                                    <li><strong>Utilisateur:</strong> ${data.username || 'Inconnu'}</li>
                                    <li><strong>OS:</strong> ${data.platform || 'Inconnu'}</li>
                                    <li><strong>IP:</strong> ${data.ip_address || 'Inconnue'}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Informations Application</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Version:</strong> ${data.current_version || 'Inconnue'}</li>
                                    <li><strong>Premi√®re connexion:</strong> ${data.first_seen || 'Inconnue'}</li>
                                    <li><strong>Derni√®re activit√©:</strong> ${data.last_seen || 'Inconnue'}</li>
                                    <li><strong>Nb. mises √† jour:</strong> ${data.update_count || '0'}</li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <h6>User Agent</h6>
                        <small class="text-muted">${data.user_agent || 'Non disponible'}</small>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    alert('Impossible de charger les d√©tails du client');
                });
        }

        function pingClient(clientId) {
            // Simuler un ping (dans une vraie impl√©mentation, cela pourrait d√©clencher une notification)
            alert(`Ping envoy√© au client ${clientId}\\n(Fonctionnalit√© de d√©monstration)`);
        }

        function deleteClient(clientId, hostname) {
            // Confirmation avant suppression
            const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer ce client ?\\n\\n` +
                                  `üñ•Ô∏è Poste: ${hostname}\\n` +
                                  `üÜî ID: ${clientId.substring(0, 8)}...\\n\\n` +
                                  `‚ö†Ô∏è Cette action est irr√©versible !`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Supprimer le client via API
            fetch(`/api/v1/clients/${clientId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:matelas2025')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succ√®s
                    alert(`‚úÖ Client "${hostname}" supprim√© avec succ√®s !\\n\\nDerni√®re connexion: ${data.deleted_client.last_seen || 'N/A'}`);
                    
                    // Recharger la page pour actualiser la liste
                    location.reload();
                } else {
                    alert(`‚ùå Erreur lors de la suppression: ${data.message || 'Erreur inconnue'}`);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur de connexion lors de la suppression\\n\\nV√©rifiez votre connexion r√©seau`);
            });
        }

        function cleanupOldClients() {
            // Demander le nombre de jours
            const days = prompt('Supprimer les clients inactifs depuis combien de jours ?\\n\\n(Par d√©faut: 30 jours)', '30');
            
            if (days === null) {
                return; // Utilisateur a annul√©
            }
            
            const daysNum = parseInt(days);
            if (isNaN(daysNum) || daysNum < 1) {
                alert('‚ùå Nombre de jours invalide !\\n\\nVeuillez entrer un nombre entier positif.');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è ATTENTION: Nettoyage automatique\\n\\n` +
                                  `Cette action va supprimer TOUS les clients inactifs ` +
                                  `depuis plus de ${daysNum} jour(s).\\n\\n` +
                                  `Cette action est IRR√âVERSIBLE !\\n\\n` +
                                  `Voulez-vous continuer ?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Effectuer le nettoyage via API
            fetch(`/api/v1/clients/cleanup/old?days=${daysNum}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:matelas2025')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = `üßπ Nettoyage termin√© !\\n\\n` +
                                 `${data.deleted_count} client(s) supprim√©(s)\\n` +
                                 `(inactifs depuis plus de ${data.cutoff_days} jours)`;
                    
                    if (data.deleted_clients && data.deleted_clients.length > 0) {
                        message += `\\n\\nClients supprim√©s:`;
                        data.deleted_clients.slice(0, 5).forEach(client => {
                            message += `\\n‚Ä¢ ${client.hostname} (${client.last_seen.substring(0, 10)})`;
                        });
                        if (data.deleted_clients.length > 5) {
                            message += `\\n... et ${data.deleted_clients.length - 5} autre(s)`;
                        }
                    }
                    
                    alert(message);
                    
                    // Recharger la page pour actualiser la liste
                    location.reload();
                } else {
                    alert(`‚ùå Erreur lors du nettoyage: ${data.message || 'Erreur inconnue'}`);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur de connexion lors du nettoyage\\n\\nV√©rifiez votre connexion r√©seau`);
            });
        }

        // Actualisation automatique toutes les 30 secondes
        setInterval(function() {
            location.reload();
        }, 30000);

        // Fonction helper pour convertir les dates
        function now() {
            return new Date();
        }
    </script>
</body>
</html>